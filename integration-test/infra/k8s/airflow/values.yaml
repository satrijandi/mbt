# Apache Airflow Helm chart - Airflow v3.1.7
# Uses KubernetesExecutor for pipeline pods

defaultAirflowRepository: localhost:30050/mbt/airflow
defaultAirflowTag: "3.1.7"

executor: KubernetesExecutor

config:
  core:
    load_examples: "false"
    dags_folder: "/opt/airflow/dags"
    executor: "KubernetesExecutor"
    # Use SimpleAuthManager (Airflow 3.x default) instead of FAB.
    # FAB requires its own DB migrations that cause check_migrations to fail.
    auth_manager: "airflow.api_fastapi.auth.managers.simple.simple_auth_manager.SimpleAuthManager"
  kubernetes_executor:
    namespace: "mbt-pipelines"
    worker_container_repository: "localhost:30050/mbt/airflow"
    worker_container_tag: "3.1.7"
    delete_worker_pods: "true"
    delete_worker_pods_on_failure: "false"
  webserver:
    expose_config: "true"

# Use external PostgreSQL
data:
  metadataSecretName: airflow-db-secret

postgresql:
  enabled: false

# Web server
webserver:
  replicas: 1
  service:
    type: ClusterIP
  resources:
    requests:
      memory: 512Mi
      cpu: 250m
    limits:
      memory: 1Gi
      cpu: 500m

# Scheduler
scheduler:
  replicas: 1
  resources:
    requests:
      memory: 512Mi
      cpu: 250m
    limits:
      memory: 1Gi
      cpu: 500m

# DAG processor
dagProcessor:
  enabled: true
  replicas: 1
  resources:
    requests:
      memory: 256Mi
      cpu: 200m

# Triggerer
triggerer:
  enabled: true
  replicas: 1
  resources:
    requests:
      memory: 256Mi
      cpu: 200m

# DAGs persistence (for deploying generated DAGs)
dags:
  gitSync:
    enabled: false
  persistence:
    enabled: true
    size: 1Gi
    accessMode: ReadWriteOnce

# Ingress — Airflow 3.x uses "apiServer" instead of the old "web" key
ingress:
  apiServer:
    enabled: true
    hosts:
      - name: "airflow.localhost"
    annotations:
      traefik.ingress.kubernetes.io/router.entrypoints: web
    path: "/"
    pathType: "Prefix"

# Service account for KubernetesPodOperator
serviceAccount:
  create: true
  name: airflow

# Airflow 3.x SimpleAuthManager:
#   - SIMPLE_AUTH_MANAGER_USERS defines username:role pairs (NOT passwords)
#   - SIMPLE_AUTH_MANAGER_PASSWORDS_FILE points to a JSON file with {"user": "password"}
#   - Without a fixed passwords file, passwords are auto-generated on each restart
extraEnv: |
  - name: AIRFLOW__CORE__SIMPLE_AUTH_MANAGER_USERS
    value: "admin:ADMIN"
  - name: AIRFLOW__CORE__SIMPLE_AUTH_MANAGER_PASSWORDS_FILE
    value: "/opt/airflow/auth/passwords.json"

extraVolumes:
  - name: auth-passwords
    emptyDir: {}

extraVolumeMounts:
  - name: auth-passwords
    mountPath: /opt/airflow/auth

extraInitContainers:
  - name: init-auth-passwords
    image: localhost:30050/mbt/airflow:3.1.7
    command: ["sh", "-c"]
    args:
      - |
        echo '{"admin": "admin"}' > /opt/airflow/auth/passwords.json
    volumeMounts:
      - name: auth-passwords
        mountPath: /opt/airflow/auth

# Disable createUserJob — not needed with SimpleAuthManager
createUserJob:
  enabled: false

# Create RBAC for scheduler
rbac:
  create: true
  createSCCRoleBinding: false
